---
title: "KadenFlorsheimDavidLÃ¼deke_Final"
author: "Kaden Florsheim"
date: "11/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(tidyverse)
library(sf)
library(tigris)
library(mapview)
library(leaflet)
library(censusapi)
Sys.setenv(CENSUS_KEY="9fbd5ddd430b595b8f3715733cae2b75c18be92e")
```

```{r}
pums_2019_1yr <- getCensus(
  name = "acs/acs1/pums",
  vintage = 2019,
  region = "public use microdata area:*", 
  regionin = "state:06",
  vars = c(
    "SERIALNO", #Unique ID for each household
    "SPORDER", #Person number
    "PWGTP", #Total number of people
    "WGTP", #Housing Weight
    "HINCP", #Household Income
    "CPLT", #Couple Type
    "FINCP", #Family Income
    "PINCP", #Total Persons Income
    "RAC1P" #Recorded Detailed Race Code
  )
)
```

```{r}
ca_pumas <-
  pumas("CA", cb = T, progress_bar = F)

counties <-
  counties("CA", cb = T, progress_bar = F)

ca_pumas <-
  ca_pumas %>% 
  st_centroid() %>% 
  .[counties, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_pumas %>% select(GEOID10)) %>% 
  st_as_sf()

ca_pums <-
  pums_2019_1yr %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0")
  ) %>% 
  filter(PUMA %in% ca_pumas$PUMACE10)
```

```{r}
cleaned <- ca_pums %>%
  mutate(
    SPORDER = as.numeric(SPORDER),
    CPLT = as.numeric(CPLT)
  ) %>% 
  filter(
    (SPORDER %in% 1:2), #assuming person 1 and 2 are the partners
    (CPLT %in% 1:4)) #filtering out N/A
```

```{r}
ca_pums_IRC <-
  cleaned %>%
  mutate(
    PWGTP = as.numeric(PWGTP),
    Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), 

      1,
      0
    ),
    Opposite_sex_household = ifelse(
        (CPLT == 1)|(CPLT == 3),
      1,
      0
    ))
    
    
    
    
    # IR = ifelse(
    #   SERIALNO == SERIALNO|RAC1P!=RAC1P,
    #   1,
    #   0
    # )
    # )
    # 
    # 

# IRC_compare <-   #Attempting to pull out Interracial couples into new data set so we can compare races
#   ca_pums_IRC %>% 
#   mutate(
#     PWGTP = as.numeric(PWGTP),
#     SERIALNO = as.numeric(SERIALNO)) %>% 
#   if(SERIALNO == SERIALNO) {
#     mutate(
#     PWGTP = as.numeric(PWGTP),
#     Same_sex_household = ifelse(
#         (CPLT == 2)|(CPLT == 4), 
# 
#       1,
#       0
#     )) 
#   }
##Can't figure out how to separate interracial couples--Trying to do if statement
#if {same serialno but different races put them in this data set or create new column}
```
    
```{r}
census_race_categories <- data.frame(
  code = c(1,2,3,4,5,6,7,8,9),
  category =
    c(
      "White alone",
      "Black or African American alone",
      "American Indian alone",
      "Alaska Native alone",
      "American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races",
       "Asian alone",
       "Native Hawaiian and Other Pacific Islander alone",
       "Some Other Race alone",
       "Two or More Races"
    ))
```
  
```{r}
census_race_categories <-
  c(
      "White alone",
      "Black or African American alone",
      "American Indian alone",
      "Alaska Native alone",
      "American Indian and Alaska Native tribes specified; or American Indian or Alaska Native, not specified and no other races",
       "Asian alone",
       "Native Hawaiian and Other Pacific Islander alone",
       "Some Other Race alone",
       "Two or More Races")
```

```{r}
ca_income_race <- 
  1:9 %>% 
  map_dfr(function(x){
    getCensus(
      name = "acs/acs1/pums",
      vintage = 2019,
      region = "public use microdata area:*", 
      regionin = "state:06",
      vars = c(
        "SERIALNO", #Unique ID for each household
        "SPORDER", #Person number
        "PWGTP", #Total number of people
        "WGTP", #Housing Weight
        "HINCP", #Household Income
        "CPLT", #Couple Type
        "FINCP", #Family Income
        "PINCP", #Total Persons Income
        "RAC1P" #Recorded Detailed Race Code
      )
    ) %>%
      select(!c(GEO_ID,state,NAME) & !ends_with(c("EA","MA","M"))) %>%
      pivot_longer(
        ends_with("E"),
        names_to = "name",
        values_to = "estimate"
      ) %>%
      left_join(
        ca_pums %>% 
          select(name, label)
      ) %>% 
      select(-name) %>% 
      separate(
        label,
        into = c(NA,NA,"income"),
        sep = "!!"
      ) %>% 
      filter(!is.na(income)) %>% 
      mutate(race = census_race_categories[x])
  })
```
 
```{r}
ca_cup <-
  getCensus(
      name = "acs/acs1/pums",
      vintage = 2019,
      region = "public use microdata area:*", 
      regionin = "state:06",
      vars = c(
        "SERIALNO", #Unique ID for each household
        "SPORDER", #Person number
        "PWGTP", #Total number of people
        "WGTP", #Housing Weight
        "HINCP", #Household Income
        "CPLT", #Couple Type
        "FINCP", #Family Income
        "PINCP", #Total Persons Income
        "RAC1P") #Recorded Detailed Race Code
  ) %>%
  left_join(
    ca_pums_IRC %>% 
      select(SERIALNO, public_use_microdata_area)
  ) 

```
%>% 
  select(-name) %>% 
  separate(
    label,
    into = c(NA,NA,"income"),
    sep = "!!"
  ) %>% 
  filter(!is.na(income))
```  
  
  ,
    White_Low_Income = ifelse(
      (RAC1P == 1) & (HINCP > 100000),
      1,
      0
    ),
    Not_White_Low_Income = ifelse(
      (RAC1P != 1) & (HINCP > 100000),
      1,
      0)) 
```

```{r}
bay_pums_couple <-
  cleaned %>% 
  Same_sex_household = ifelse(
        (CPLT == 2)|(CPLT == 4), 
        WGTP,
        0)
# %>% 
  # group_by(PUMA) %>% 
  # summarize(
  #   PERSON1 =
  #     sum(Person1, na.rm =T)
  # ) 
```
```

```{r}
bay_pums_couple <-
  cleaned %>%
  mutate(
    WGTP = as.numeric(WGTP),
    SPORDER = as.numeric(SPORDER),
    partner1 = ifelse(
      (SPORDER == 1),
      WGTP,
      0
    ),
    partner2 = ifelse(
      (SPORDER == 2),
      WGTP,
      0
    ) %>% 
  group_by(PUMA) %>%
  summarize(
    partner1 =
      sum(partner1, na.rm =T),
    partner2 =
      sum(partner2, na.rm =T))
  )
```



    
    ,
    Same_sex_household = ifelse(
      (HINCP < 100000) &
        (CPLT == 2)|(CPLT == 4), 
        
      WGTP,
      0
    ),
    Opposite_sex_household = ifelse(
      (HINCP < 100000) &
        (CPLT == 1)|(CPLT == 3),
      WGTP,
      0
    ),
    White = ifelse(
      (SERIALNO == 1) &
      (RAC1P == 1),
      WGTP,
      0
    )
    
    
    ) %>% 
  group_by(PUMA) %>%
  summarize(
    sum_same_sex_household =
      sum(Same_sex_household, na.rm =T),
    sum_opposite_sex_household =
      sum(Opposite_sex_household, na.rm =T),
    partner1 =
      sum(partner1, na.rm =T),
    partner2 =
      sum(partner2, na.rm =T)%>% 
  left_join(
    bay_pumas %>% 
      select(PUMACE10),
    by = c("PUMA" = "PUMACE10")
  ) %>% 
  st_as_sf()
  ) 
```

```{r}
bay_pums_couple <-
  cleaned %>%
  mutate(
    WGTP = as.numeric(WGTP),
    partner1 = ifelse(
      (SPORDER == 1),
      WGTP,
      0
    ),
    partner2 = ifelse(
      (SPORDER == 2),
      WGTP,
      0
    ),
    Same_sex_household = ifelse(
      (HINCP < 100000) &
        (CPLT == 2)|(CPLT == 4), 
        
      WGTP,
      0
    ),
    Opposite_sex_household = ifelse(
      (HINCP < 100000) &
        (CPLT == 1)|(CPLT == 3),
      WGTP,
      0
    ),
    White = ifelse(
      (SERIALNO == 1) &
      (RAC1P == 1),
      WGTP,
      0
    )
    




```


```{r}
acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )
```


```{r}
veteran <-
    getCensus(
      name = "acs/acs5",
      vintage = 2019,
      region = "county:055",
      regionin = "state:06",
      vars = "group(S2101)" 
    ) %>%
      select(!c(GEO_ID,state,NAME,county) & !ends_with(c("EA","MA","M"))) %>%
      pivot_longer(
        ends_with("E"),
        names_to = "name",
        values_to = "estimate"
      ) %>%
      left_join(
        acs_vars_2019_5yr %>% 
          select(name, label)
      )
```

##How would we filter out just first two people to determine their races? Is sample size too small?


##Veterans, Jobs, Race< which war, income













































